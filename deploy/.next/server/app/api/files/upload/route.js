(()=>{var e={};e.id=533,e.ids=[533],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},23791:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>y,serverHooks:()=>v,workAsyncStorage:()=>q,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>f});var a=r(36044),i=r(63409),o=r(9576),u=r(10949),n=r(54686),l=r(79748),p=r(33873),d=r(55511),c=r(74075),m=r.n(c);let x={free:{name:"free",quotaBytes:0x80000000,uploadLimitBytes:0xc800000,maxAccounts:1,defaultExpiryDays:30,streamQuality:"720p"},paid:{name:"paid",quotaBytes:0x140000000,uploadLimitBytes:524288e3,maxAccounts:2,defaultExpiryDays:null,streamQuality:"1080p"},developer:{name:"developer",quotaBytes:0x200000000,uploadLimitBytes:0x40000000,maxAccounts:3,defaultExpiryDays:null,streamQuality:"1080p"},team:{name:"team",quotaBytes:0x280000000,uploadLimitBytes:0x40000000,maxAccounts:null,defaultExpiryDays:null,streamQuality:"2160p"},enterprise:{name:"enterprise",quotaBytes:null,uploadLimitBytes:null,maxAccounts:null,defaultExpiryDays:null,streamQuality:"custom"}};async function f(e){try{let t=(0,n.R)();if(!t)return u.NextResponse.json({error:"Database connection failed"},{status:500});let{data:{user:r}}=await t.auth.getUser();if(!r)return u.NextResponse.json({error:"Authentication required"},{status:401});let s=(await e.formData()).get("file");if(!s)return u.NextResponse.json({error:"No file provided"},{status:400});let{data:a}=await t.from("users").select("*").eq("email",r.email).single(),i=x[(a?.plan||a?.subscription_type||"free")?.toLowerCase()||"free"]||x.free;if(i.uploadLimitBytes&&s.size>i.uploadLimitBytes)return u.NextResponse.json({error:`Upload limit is ${(i.uploadLimitBytes/1048576).toFixed(0)}MB for your plan.`},{status:400});let{data:o}=await t.from("users").select("*").eq("email",r.email).single();if(!o)return u.NextResponse.json({error:"User not found"},{status:404});if(o.quota_used+s.size>o.quota_limit){let e=((o.quota_limit-o.quota_used)/0x40000000).toFixed(2);return u.NextResponse.json({error:`Quota exceeded. You have ${e} GB remaining.`},{status:400})}let c=Buffer.from(await s.arrayBuffer()),f=(0,d.createHash)("sha256").update(c).digest("hex"),{data:y}=await t.from("files").select("*").eq("user_id",o.id).eq("file_hash",f).single();if(y)return u.NextResponse.json({error:"File already exists in your storage"},{status:400});let q=s.name.split(".").pop()||"",g=`${(0,d.randomBytes)(16).toString("hex")}.${q}`,v=(0,d.randomBytes)(16).toString("hex"),h=(0,p.join)(process.cwd(),"storage","files",o.id);await (0,l.mkdir)(h,{recursive:!0});let _=(0,p.join)(h,`${g}.gz`),B=m().gzipSync(c);await (0,l.writeFile)(_,B);let{error:w}=await t.from("files").insert({user_id:o.id,original_name:s.name,stored_name:`${g}.gz`,file_size:s.size,mime_type:s.type,file_hash:f,share_token:v,is_public:!0});if(w)return console.error("Database error:",w),u.NextResponse.json({error:"Failed to save file record"},{status:500});return await t.from("users").update({quota_used:o.quota_used+s.size}).eq("id",o.id),u.NextResponse.json({success:!0,shareToken:v})}catch(e){return console.error("Upload error:",e),u.NextResponse.json({error:"Upload failed"},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/files/upload/route",pathname:"/api/files/upload",filename:"route",bundlePath:"app/api/files/upload/route"},resolvedPagePath:"/workspace/app/api/files/upload/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:q,workUnitAsyncStorage:g,serverHooks:v}=y;function h(){return(0,o.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:g})}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30496:()=>{},33873:e=>{"use strict";e.exports=require("path")},43648:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54686:(e,t,r)=>{"use strict";r.d(t,{R:()=>i});var s=r(22057),a=r(15886);async function i(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;if(!e||!t)return console.warn("[Server Client] Supabase environment variables not found"),null;try{let r=await (0,a.UL)();return(0,s.createServerClient)(e,t,{cookies:{get:e=>r.get(e)?.value,set(e,t,s){try{r.set(e,t,s)}catch{}},remove(e,t){try{r.set(e,"",{...t,maxAge:0})}catch{}}}})}catch(e){return console.error("[Server Client] Error creating Supabase client:",e),null}}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79551:e=>{"use strict";e.exports=require("url")},79748:e=>{"use strict";e.exports=require("fs/promises")},81630:e=>{"use strict";e.exports=require("http")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9369,6550,2920],()=>r(23791));module.exports=s})();